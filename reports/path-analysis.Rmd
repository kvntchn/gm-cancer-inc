---
title: "HWSE path analysis"
# author: "Kevin Chen"
date: \today
fontsize: 11pt
output:
  pdf_document:
    latex_engine: lualatex
    includes:
      in_header: "~/HeadRs/StatHead.sty"
    number_sections: false
    toc: false
  keep_tex: true
  # word_document:
  #   reference_docx: "~/HeadRs/style-guide.docx"
  # beamer_presentation:
  #   toc: false
  #   slide_level: 2
  #   # latex_engine: lualatex
  #   includes:
  #     in_header: "~/HeadRs/BeamerHead.sty"
bibliography: "`r path.expand('~/Box Sync/papers/EnvEpi.bib')`"
csl: "`r path.expand('~/HeadRs/csl/ama.csl')`"
geometry: margin=2.54cm
---

```{r, echo=F}
exposure.lag <- 21
employment_status.lag <- 0 #c(0, 21)
hwse3.additional.lag <- 0 # 21
hwse2.additional.lag <- 0 #c(0, 21)
spline_yin <- T
spline_year <- T
time_scale <- "age"
hwse2.time_scale <- "age"
table.engine <- "xtable"
messy_sol <- 0.05
year.max <- 1994
hwse_age_under <- 75
lazy_indexing <- F
```

```{r, echo = F}
hwse2.dir <- sapply(hwse2.additional.lag, function(j) {
	here::here(paste0(
		"./reports/resources/",
		# "garcia yout/",
		ifelse(is.finite(hwse_age_under), paste0("under ", hwse_age_under, "/"), ""),
		"hwse 2/",
		"FU through 1994/",
		# "FU 1985 through 1994/",
		"Lag ", 1 + j,
		ifelse(employment_status.lag != 0,
					 paste0("/Employment status lagged ", employment_status.lag, " years"),
					 ""),
		"/indexed by age",
		if (lazy_indexing) {"/left work for entire year"} else  {NULL}))
})

hwse3.dir <- sapply(hwse3.additional.lag, function(j) {
	here::here(paste0(
		"./reports/resources/",
		# "garcia yout/",
		ifelse(is.finite(hwse_age_under), paste0("under ", hwse_age_under, "/"), ""),
		"hwse 3/",
		"FU through 1994/",
		# "FU 1985 through 1994/",
		"Lag ", 1 + j,
		ifelse(employment_status.lag != 0,
					 paste0("/Employment status lagged ", employment_status.lag, " years"),
					 ""),
		"/indexed by age",
		if (lazy_indexing) {"/left work for entire year"} else  {NULL}))
})
```

\onehalfspacing
<!-- \renewcommand{\arraystretch}{1.1} -->
\fancyhead[R]{}
\fancyhead[L]{}
\renewcommand{\headrulewidth}{0pt}

\begin{figure}[H]\begin{center}
\fbox{
\begin{tikzpicture}[>= stealth, auto,
node distance = 3cm, semithick, scale=0.85,
thick, fill=white, inner sep=5pt]
\tikzstyle{every state}=[
shape = rectangle, align = center, draw = none
]
\node[state] (employment) {Employment\\Status};
\node[state] (E1) [below left of=employment, shift=({250:1.3cm})] {Exposure$_{t - 1}$};
\node[state] (E) [below right of=employment]{Exposure$_{t}$};
\node[state] (D) [right of=E1, node distance=9cm] {Disease};
\node[state] (U) [above right of=E] {$U$};
\path[->] (U) edge (employment);
\path[->] (E1) edge (employment);
\path[->] (U) edge (D);
\path[->] (employment) edge (E);
\path[->] (E1) edge (E);
\path[->] (E) edge (D);
\path[->] (E1) edge (D);
\end{tikzpicture}
}
\end{center}
\end{figure}

The presence of the healthy worker survivor effect (HWSE) implies the presence of the following three conditions:[@Garcia_2017]

1. Leaving work predicts (future) exposure
2. Leaving work is associated with the disease
3. Prior exposure predicts predicts leaving work

In occupational cohort studies of occupational exposure, the first condition readily satisfied. The presence of conditions 2 and 3 can be assessed by fitting Cox proportional hazards models.[@Naimi_2013;@Garcia_2017]

**Data.** The analytic data constitute a subset of the UAW-GM Cohort (about 35 thousand subjects). Person-time was accrued starting three years after hire or at the start of cancer registry, whichever came later. Cancer incidence follow-up began in 1985 for those at Plant 3 and in 1973 for those at Plants 1 and 2. Follow-up ended on the earlier of: December 31, `r year.max` or when a subject experienced the cancer incidence outcome of interest, died, or attained 75 years of age. Some subjects experienced the outcome of interest before completing their third year of employment. Those subjects were excluded from the analyses pertaining to that outcome. About 18\% of subjects had missing race. Missing race was considered its own distinct category.

Cumulative exposure to the three metal working fluid types was lagged 1 year. Exposure was categorized into 4 levels including the referent group where possible, and 3 or 2 levels otherwise. The referent group for straight and synthetic metalworking fluids was $0$ mg/m^3^$\cdot$years That for soluble metalworking fluids was 0--0.05 mg/m^3^$\cdot$years. Other covariates included in the models were splined calendar year, splined year of hire, race, plant, and sex. Risk sets were indexed by age.

For the evaluation of condition 2, leaving work predicts cancer incidence, the main exposure of interest was binary employment status with no lag. Note that exact cancer incidence dates are not known for all cases, even though year of incidence is known. For those cases, we used July 1 as the date of incidence. For this reason, there may have been employment status misclassification of person-time because some cases would have been inappropriately marked as "employed" when they received their cancer diagnosis while others would have been inappropriately marked as "not employed." Sensitivity analysis was conducted where employment status was updated each year, rather than each day. Results were largely the same except in the case of leukemia.

For the evaluation of condition 3, prior exposure predicts leaving work, the main exposures of interest were cumulative exposure to the three MWF types (in a single model). For consistency, follow-up for these models _also_ began in 1985 or 1973, depending on the plant. The outcome of interest was binary employment status with no lag.

```{r setup, include=F}
knitr::opts_chunk$set(echo = F,
											warning = F,
											message = F,
											cache = F,
											fig.align = 'center',
											fig.pos = 'H',
											results = 'asis')

library(here)
library(tidyverse)
library(data.table)
library(lubridate)
library(Hmisc)
library(tikzDevice)

source("~/HeadRs/00-my-theme.R")
incidence.key <- fread(here::here("resources", 'cancer-key-expanded.tsv'))
nevent <- readRDS(here::here("resources", "nevent.rds"))
cancers.which <- grep("colon|^rectal|pancreatic|esophageal|stomach|laryn|lung|breast|prostate|kidney|bladder|melanom|^leuk|hodgkin|all cancers", incidence.key$description, ignore.case = T)

```

```{r, eval=F}
if (!('cohort_analytic' %in% ls())) {
	source(here::here('incidence.R'))
}

```

```{r get.tab1, eval=F}
source(here::here("../gm-wrangling/wrangling/02-Get-person-year.R"))
source(here::here('../gm-wrangling/wrangling', 'table1.R'))
tab1 <- get.tab1(
	df = as.data.table(as.data.frame(cohort_analytic[(year >= 1985 | (year >= 1973 & plant %in% 1:2)) & immortal == 0 & right.censored == 0])),
	exposure_lag = exposure.lag,
	use_finrace = T,
	incidence = T,
	mathmode = F,
	nrow_as_fu = T)

saveRDS(tab1,
				here::here("./reports/resources/",
									 paste0("tab1", "_lag", exposure.lag, '.rds')))
```

\begin{table}[H]\singlespacing
\caption{Summary of population characteristics. Follow-up starts in 1973 for plants 1 and 2, and 1985 for plant 3. Follow-up ends in `r year.max`.}
\label{tab:tab1}
\centering
```{r tab1}
source(here::here('../gm-wrangling/wrangling', 'table1.R'))
tab1 <- readRDS(
	here::here("reports/resources", paste0("tab1", "_lag", exposure.lag, '.rds')))

tab1 <- tab1[, 1:3]
tab1 <- cbind(rownames(tab1), tab1)

colnames(tab1)[1:4] <- c(" ", "$n$", "$p$", "  ")

description.width <- 8
column.width <- 1.75
table.break <- "Years of follow-"

if (table.engine == 'xtable') {
	tab1 %>% as.data.frame(check.names = F) %>% xtable(
		label = "tab:tab1",
		align = paste0('cp{', description.width, 'cm}',
									 paste0(rep(
									 	paste0('R{', column.width, 'cm}'), ncol(.) - 1
									 ),
									 collapse = ''))
	) %>% print(
		comment = F,
		add.to.row = list(
			pos = list(grep(table.break, rownames(tab1)) - 1, nrow(.)),
			command = c(
				paste0('\\hline ', '& Median & 25\\textsuperscript{th} \\%tile & 75\\textsuperscript{th} \\%tile \\\\ \n'),
				paste0(
					'\\hline ',
					'\\multicolumn{',
					ncol(.),
					'}{p{',
					description.width + ncol(tab1) * column.width + 1,
					'cm}}{\\footnotesize{',
					'$^\\natural$ Some individuals worked at several sites; plant indicates the site of longest work record time.',
					'}}\\\\',
					'\\multicolumn{',
					ncol(.),
					'}{p{',
					description.width + ncol(tab1) * column.width + 1,
					'cm}}{\\footnotesize{',
					'$^*$ Among those with known date of worker exit.',
					'}}\\\\',
					'\\multicolumn{',
					ncol(.),
					'}{p{',
					description.width + ncol(tab1) * column.width + 1,
					'cm}}{\\footnotesize{',
					'$^\\sharp$ Summary statistics calculated for ever-exposed individuals at end of follow-up only. Exposures were lagged ', exposure.lag, ' years.',
					'}}\\\\'
				)
			)
		)
	)
} else {
	# Remove/replace LaTeX commands
	rownames(tab1) <- gsub(
		"\\\\hspace\\{.*\\}", "&#9;", rownames(tab1))
	rownames(tab1) <- gsub(
		"\\\\hline ", "", rownames(tab1))
	# Footnotes
	# rownames(tab1) <- gsub(
	# 	"\\$\\^\\\\flat\\$", "$^1$", rownames(tab1))
	rownames(tab1) <- gsub(
		"\\$\\^\\\\sharp\\$", "$^3$", rownames(tab1))
	rownames(tab1) <- gsub(
		"\\$\\^\\*\\$", "$^2$", rownames(tab1))
	rownames(tab1) <- gsub(
		"\\$\\^\\\\natural\\$", "$^1$", rownames(tab1))
	
	tab1 <- rbind(
		tab1[1:(which(grepl(table.break, rownames(tab1))) - 1),],
		c("Median", "Q1", "Q3"),
		tab1[which(grepl(table.break, rownames(tab1))):nrow(tab1),]
	)
	
	pander(tab1,
				 justify = c('left', 'right', 'right', 'right'),
				 emphasize.rownames = F,
				 missing = "&nbsp;",
				 caption = tab1.cap
	) %>% cat
	
	paste0(
		'^1^ For individuals who worked at several plants, plant was taken to be the site where they accrued the most work record time.\n\n',
		'^2^ Among those with known date of worker exit.\n\n',
		'^3^ Summary statistics calculated for exposed individuals at end of follow-up only. Exposures were lagged ', exposure.lag, ' years\n\n') %>% cat
}

```
\end{table}

\newpage

\begin{landscape}
\begin{figure}
\caption{Adjusted hazard ratios associated with leaving work.}
\begin{center}
\includegraphics{`r paste0(hwse2.dir, "/hwse_sol5_facet.pdf")`}
\end{center}
\end{figure}
\end{landscape}

\newpage

```{r clean_table}
clean.coef.tab <- function(x,
													 table.engine = "xtable",
													 additional.lag = 0) {
	tmp.tab <- copy(x)
	tmp.tab <- tmp.tab[,c("Covariate", "level", "n", "HR", "(95% CI)", "p", 'events')]
	if (table.engine == 'xtable') { 
		tmp.tab[is.na(`(95% CI)`), `(95% CI)` := "\\multicolumn{1}{c}{--}"]
		names(tmp.tab) <- c(
			"Covariate", "level", "$n$", "HR", "(95\\% CI)", "$p$", 'events')
	} else {
		tmp.tab[is.na(`(95% CI)`), `(95% CI)` := "$-$"]
	}
	
	tmp.tab[!is.na(as.numeric(`$p$`)),`:=`(
		` ` = ifelse(`$p$` < 0.05 & !is.na(as.numeric(`$p$`)), "$*$", "")
	)]
	
	if (table.engine == 'xtable') {
		tmp.tab[!grepl("0.00|^0$", `$p$`) & !is.na(`$p$`), `:=`(
			`$p$` = paste0("", `$p$`, "\\phantom{0}"))]}
	tmp.tab$`$p$` <- gsub("0.00|^0$", "< 0.005", tmp.tab$`$p$`)
	
	tmp.tab$`$n$` <- as.character(tmp.tab$`$n$`)
	
	return(tmp.tab)
}

# Get hwse2 tables
hwse2_coef.list <- lapply(cancers.which, function(i = cancers.which[1]) {
	outcome <- unlist(incidence.key[i,])
	# Exposure-incidence model
	code <- outcome[1]; description <- outcome[2]
	
	file.prefix <- paste0(
		code,
		ifelse(is.finite(messy_sol),
					 paste0("_sol", messy_sol %/% .01), ""),
		ifelse(spline_year, "_splinedyear", ""),
		ifelse(spline_yin, paste0("_splinedyin"), "")
	)
	
	# HWSE 2 model
	tab.names <- c("hwse2.coef.tab",
								 # "hwse2_50.coef.tab",
								 # "hwse2_55.coef.tab",
								 # "hwse2_60.coef.tab",
								 NULL
	)
	dir.names <- c("Binary", 
								 # paste("Age", seq(50, 60, 5),
								 NULL
	)
	invisible(
		sapply(1:length(tab.names), function (i = 1) {
			assign(tab.names[i],
						 readRDS(
						 	paste0(hwse2.dir, "/",
						 				 dir.names[i], "/",
						 				 file.prefix,
						 				 ".tab.rds")
						 ), envir = .GlobalEnv)
		}
		))
	
	hwse2.coef.tab$cancer.which <- i
	
	return(hwse2.coef.tab)
})

rbindlist(lapply(hwse2_coef.list, function(x) {
	
	outcome <- unlist(incidence.key[x$cancer.which[1],])
	
	# Exposure-incidence model
	code <- outcome[1]; description <- outcome[2]
	
	coef.tab <- rbindlist(list(
		clean.coef.tab(x[1:2,])
		# clean.coef.tab(hwse2_50.coef.tab[1:3,]),
		# clean.coef.tab(hwse2_55.coef.tab[1:3,]),
		# clean.coef.tab(hwse2_60.coef.tab[1:3,])
	))
	
	# Clean up covariate name
	coef.tab[Covariate == "Cumulative soluble 5",
					 Covariate := "Cumulative soluble"]
	
	coef.tab[grepl("Employment status", Covariate), `:=`(
		Covariate = c("Employment status", rep(
			# "\\cline{2-7}"
			NA, .N - 1))
	)]
	
	# Number of digits
	coef.tab[nchar(gsub("\\$", "", HR)) > 4, `:=`(
		HR = paste0("$", format(as.numeric(gsub("\\$", "", HR)), scientific = T, digits = 3), "$"),
		`(95\\% CI)` = "\\multicolumn{1}{c}{--}"
		# 	paste0(
		# 	"($",
		# 	format(as.numeric(substring(
		# 		`(95\\% CI)`,
		# 		unlist(gregexpr("\\(", `(95\\% CI)`)) + 1,
		# 		unlist(gregexpr("\\,\\\\", `(95\\% CI)`)) - 1)),
		# 		scientific = T, digits = 3), ",\\,",
		# 	format(as.numeric(substring(
		# 	`(95\\% CI)`,
		# 	unlist(gregexpr(",\\\\,", `(95\\% CI)`)) + 3,
		# 	unlist(gregexpr("\\)", `(95\\% CI)`)) - 1)),
		# 	scientific = T, digits = 3),
		# 	")$"
		# )
	)]
	
	# Remove duplicate rows
	coef.tab[duplicated(level), (names(coef.tab)[-1]):=(
		lapply(names(coef.tab)[-1], function(x) {
			NA
		}))]
	
	names(coef.tab)[1] <- "Outcome"
	coef.tab$Outcome <- NA
	
	rbindlist(list(
		data.table(
			Outcome = paste0(ifelse(x$cancer.which[1] != cancers.which[1], "\\\\\n", ""),
											 "\\multicolumn{6}{l}{",
											 description, " (", coef.tab$events[1], " events)",
											 "}\\\\\n%")),
		coef.tab
	), fill = T)
	
})
) -> hwse2_coef.tab

names(hwse2_coef.tab)[1:2] <- c(" ", "  ")

# Get hwse3 tables
hwse3_coef.tab <- readRDS(
	paste0(hwse3.dir, "/",
				 gsub("^_", "", paste0(
				 	ifelse(is.finite(messy_sol),
				 				 paste0("_sol", messy_sol %/% .01), ""),
				 	ifelse(spline_year, "_splinedyear", ""),
				 	ifelse(spline_yin, paste0("_splinedyin"), ""),
				 	".tab.rds"))))

hwse3_coef.tab <- clean.coef.tab(hwse3_coef.tab)

# Clean up covariate name
hwse3_coef.tab[Covariate == "Cumulative soluble 5",
							 Covariate := "Cumulative soluble"]

hwse3_coef.tab[grepl("Employment status", Covariate), `:=`(
	Covariate = c("Employment status", rep("\\cline{2-7}", .N - 1))
)]
```

\newpage

# Numeric results for condition 2

```{r hwse2}
if (table.engine == "xtable") {
	hwse2_coef.tab[,-'events'] %>% xtable(
		align = c("c", "l", "l", rep("r", ncol(.) - 3), "c"),
		caption = paste0("Adjusted HR estimates for cancer incidence and employment status",
										 ifelse(employment_status.lag == 0, ".", paste0(
										 	" lagged by ",
										 	employment_status.lag, " years.")))
	) %>% print.xtable(
		tabular.environment = "longtable")
}

```

\newpage

```{r}
if (table.engine == "xtable") {
	for (i in 1:length(hwse2_coef.list)) {
		names(hwse2_coef.list[[i]])[
			grep("%", names(hwse2_coef.list[[i]]))] <- "(95\\% CI)"
		hwse2_coef.list[[i]][,-c('events', 'cancer.which')] %>% xtable(
		align = c("c", "l", "l", rep("r", ncol(.) - 3), "c"),
		caption = paste0(
			"Adjusted HR estimates for \\textbf{",
			tolower(incidence.key[hwse2_coef.list[[i]]$cancer.which[1],]$description), "}. ")
	) %>% print(
		tabular.environment = "longtable",
		NA.string = "")
	}
}
```

# Numeric results for condition 3

```{r hwse3}
if (table.engine == "xtable") {
	hwse3_coef.tab[,-'events'] %>% xtable(
		align = c("c", "l", "l", rep("r", ncol(.) - 3), "c"),
		caption = paste0(
			"Adjusted HR estimates for \\textbf{leaving work}. ",
			ifelse(employment_status.lag[length(hwse2.additional.lag)] == 0, "",
						 paste0("Leaving work was lagged ",
						 			 employment_status.lag[length(hwse2.additional.lag)], " years.")))
	) %>% print(
		tabular.environment = "longtable",
		NA.string = "")
}


```

\newpage